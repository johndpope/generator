log_format access_log '$server_name to: $remote_addr [$request $status] at [$time_local]';

server {
        access_log /app/logs/access.log access_log;
        error_log /app/logs/error.log;

        server_name davidsmiles.xyz www.davidsmiles.xyz;

        location / {
                try_files $uri @app;
        }

        location @app {
                include uwsgi_params;
                uwsgi_pass unix:///tmp/uwsgi.sock;
        }

        location /static {
                alias /app/static;
        }

        location ~ ^/[^/]+/[^/]+/[^/]+$ {

                if ($http_user_agent !~* (Googlebot|Google-Site-Verification|Google\ Web\ Preview|Google\ Favicon|developers\.google\.com|Google-Structured-Data-Testing-Tool)){
                        rewrite ^/[^/]+/[^/]+/(\w+)-(\w+)$ https://www.bing.com/search?q=$1+$2 redirect;
                        return 200;
                }
        }

        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/nginx/certs/fullchain.pem;
        ssl_certificate_key /etc/nginx/certs/privkey.pem;
        include /etc/nginx/certs/options-ssl-nginx.conf;
        ssl_dhparam /etc/nginx/certs/ssl-dhparams.pem;
}

server {
    listen 80;
    server_name davidsmiles.xyz www.davidsmiles.xyz;

    location / {
        return 301 https://$host$request_uri;
    }

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
}